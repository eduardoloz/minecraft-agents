<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Agents Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>â›ï¸ Minecraft Agents Dashboard</h1>
            <p class="subtitle">Real-time AI Bot Monitoring</p>
            <div class="api-status">
                <div class="api-dot" id="apiDot"></div>
                <span id="apiStatusLabel">API Offline</span>
            </div>
        </header>

        <div class="stats-bar">
            <div class="stat-box">
                <div class="stat-number" id="statTotalBots">â€”</div>
                <div class="stat-label">Total Bots</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="statActiveBots">â€”</div>
                <div class="stat-label">Active Bots</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="statOnline">â€”</div>
                <div class="stat-label">Online Now</div>
            </div>
        </div>

        <!-- AI Bots Section -->
        <div class="section">
            <h2 class="section-title">ğŸ¤– AI Bots</h2>
            <div id="apiBotCards" class="cards"></div>
        </div>

        <!-- Instruction Window -->
        <div class="instruction-window">
            <div class="instruction-header">
                <div>
                    <div class="instruction-title">ğŸ“ Send Instruction</div>
                    <div class="instruction-target" id="targetName">Select a bot to instruct</div>
                </div>
                <select class="command-type-select" id="commandType" onchange="updateCommandFields()">
                    <option value="task">Task</option>
                    <option value="explore">Explore</option>
                    <option value="subgoal">Subgoal</option>
                    <option value="skill">Skill</option>
                    <option value="stop">Stop</option>
                    <option value="pop_queue">Pop Queue</option>
                </select>
            </div>

            <textarea id="instructionInput" class="instruction-input"
                placeholder="Enter instruction (e.g., 'Mine 10 diamonds')"></textarea>

            <div class="extra-fields" id="subgoalFields">
                <label>Sub-goals (one per line):</label>
                <textarea id="subGoalsInput" class="instruction-input" style="min-height:60px;"
                    placeholder="chop oak tree&#10;collect 10 logs"></textarea>
            </div>

            <div class="extra-fields" id="skillFields">
                <label>Skill path:</label>
                <input type="text" id="skillPathInput" placeholder="./skill_library/craftWoodenPlanks.js">
            </div>

            <div class="extra-fields" id="stopFields">
                <label><input type="checkbox" id="clearQueueInput"> Clear task queue</label>
            </div>

            <div class="extra-fields" id="taskOptions" style="display:flex;gap:16px;align-items:center;">
                <label><input type="checkbox" id="preemptInput"> Preempt (interrupt current task)</label>
                <label><input type="checkbox" id="resetEnvInput"> Reset env</label>
            </div>

            <div class="button-row">
                <button class="instruction-button" onclick="sendInstruction()">âš¡ Send</button>
                <button class="instruction-button-override" onclick="overrideInstruction()">ğŸ”¥ OVERRIDE INSTRUCTION</button>
                <button class="instruction-button-stop" onclick="stopSelectedBot()">â¹ Stop Bot</button>
            </div>
        </div>

        <!-- Conversations Panel -->
        <div class="section" id="conversationsSection">
            <div class="section-title">
                ğŸ’¬ LLM Conversations
                <span id="convoBotLabel" style="font-size:0.75em;color:#a0a0a0;margin-left:8px;">â€” select a bot</span>
                <button class="btn-sm btn-select" style="float:right;margin-top:2px;" onclick="fetchConversations()">Refresh</button>
            </div>
            <div style="color:#a0a0a0;margin-bottom:8px;font-size:0.85em;">
                Every LLM turn for the last completed task. Each turn = one action-agent attempt (up to 4 retries per task).
            </div>
            <div id="conversationsContainer">
                <div style="color:#555;font-size:0.85em;padding:6px 0;">Select a bot to view its conversations.</div>
            </div>
        </div>

        <!-- Server Activity Log -->
        <div class="section">
            <div class="section-title">ğŸ“¡ Server Activity</div>
            <div style="color:#a0a0a0; margin-bottom:8px; font-size:0.85em;">Recent bot join/leave messages</div>
            <div id="serverLogContainer">
                <div class="log-entry">
                    <div class="log-time">--:--:--</div>
                    <div class="log-action">No events recorded yet.</div>
                </div>
            </div>
        </div>

        <!-- Spawn Bot -->
        <div class="section">
            <div class="section-title">âš¡ Spawn Bot</div>
            <div class="spawn-form">
                <div class="spawn-form-group">
                    <label>Bot Name *</label>
                    <input type="text" id="spawnName" placeholder="bot1">
                </div>
                <div class="spawn-form-group">
                    <label>MC Port *</label>
                    <input type="text" id="spawnPort" placeholder="3000">
                </div>
                <div class="spawn-form-group">
                    <label>Username</label>
                    <input type="text" id="spawnUsername" placeholder="Steve">
                </div>
                <div class="spawn-form-group">
                    <label>Environment</label>
                    <select id="spawnEnvironment">
                        <option value="">Default</option>
                        <option value="explore">Explore</option>
                        <option value="combat">Combat</option>
                        <option value="farming">Farming</option>
                        <option value="subgoal">Subgoal</option>
                    </select>
                </div>
                <div class="spawn-form-group">
                    <label>Model</label>
                    <select id="spawnModel">
                        <option value="">Default</option>
                        <option value="llama3_8b_v3">llama3_8b_v3</option>
                        <option value="llama3_8b">llama3_8b</option>
                        <option value="llama3_70b_v1">llama3_70b_v1</option>
                        <option value="qwen2-7b">qwen2-7b</option>
                        <option value="qwen2-72b">qwen2-72b</option>
                    </select>
                </div>
            </div>
            <button class="instruction-button" onclick="spawnBot()">âš¡ Spawn Bot</button>
        </div>
    </div>

    <div id="apiToast"></div>

    <script>
        const API_BASE = 'http://localhost:8001';
        let selectedBot = null;

        // â”€â”€ API helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function apiCall(method, path, body) {
            const opts = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) opts.body = JSON.stringify(body);
            const res = await fetch(API_BASE + path, opts);
            if (!res.ok) {
                const text = await res.text().catch(() => res.statusText);
                throw new Error(`${res.status}: ${text}`);
            }
            return res.json().catch(() => ({}));
        }

        let _toastTimer = null;
        function showApiToast(msg, isError = false) {
            const el = document.getElementById('apiToast');
            el.textContent = msg;
            el.className = isError ? 'error' : 'success';
            el.style.display = 'block';
            clearTimeout(_toastTimer);
            _toastTimer = setTimeout(() => { el.style.display = 'none'; }, 3500);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // â”€â”€ API status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function checkApiStatus() {
            const dot = document.getElementById('apiDot');
            const label = document.getElementById('apiStatusLabel');
            try {
                await fetch(API_BASE + '/bots', { signal: AbortSignal.timeout(3000) });
                dot.classList.add('online');
                label.textContent = 'API Connected';
            } catch {
                dot.classList.remove('online');
                label.textContent = 'API Offline';
            }
        }

        // â”€â”€ Bot listing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function fetchBots() {
            try {
                const data = await apiCall('GET', '/bots');
                // API returns either an array or an object keyed by bot name
                const bots = Array.isArray(data) ? data : Object.values(data);
                renderApiBots(bots);
                updateActivityFromBots(bots);
                const active = bots.filter(b => b.status === 'running').length;
                const online = bots.filter(b => b.status !== 'dead').length;
                document.getElementById('statTotalBots').textContent = bots.length;
                document.getElementById('statActiveBots').textContent = active;
                document.getElementById('statOnline').textContent = online;
            } catch {
                renderApiBots([]);
            }
        }

        function renderApiBots(bots) {
            const container = document.getElementById('apiBotCards');
            container.innerHTML = '';
            if (bots.length === 0) {
                container.innerHTML = '<div style="color:#666;font-size:0.85em;padding:8px 0;">No live bots â€” start a bot or check the API connection.</div>';
                return;
            }
            bots.forEach(bot => {
                const statusClass = { idle: 'idle', running: 'online', error: 'offline', dead: 'offline', starting: 'idle' }[bot.status] || 'idle';
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-header">
                        <span class="player-name">${escapeHtml(bot.name)}<span class="bot-badge">AI</span></span>
                        <span class="status ${statusClass}">${escapeHtml(bot.status)}</span>
                    </div>
                    <div class="card-stats">
                        <div class="stat-item"><span>Port:</span><span class="stat-value">${bot.port ?? 'â€”'}</span></div>
                        <div class="stat-item"><span>User:</span><span class="stat-value">${escapeHtml(bot.username || 'â€”')}</span></div>
                        <div class="stat-item"><span>Task:</span><span class="stat-value">${escapeHtml(bot.currentTask || 'idle')}</span></div>
                    </div>
                    <div class="live-bot-actions">
                        <button class="btn-sm btn-select" onclick="selectBotByName('${escapeHtml(bot.name)}')">Select</button>
                        <button class="btn-sm btn-stop"   onclick="stopBotByName('${escapeHtml(bot.name)}')">Stop</button>
                        <button class="btn-sm btn-kill"   onclick="killBotByName('${escapeHtml(bot.name)}')">Kill</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // â”€â”€ Bot actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function selectBotByName(name) {
            selectedBot = name;
            document.getElementById('targetName').textContent = `Instructing: ${name}`;
            document.getElementById('convoBotLabel').textContent = `â€” ${name}`;
            showApiToast(`Selected bot: ${name}`);
            fetchConversations();
        }

        // â”€â”€ Conversations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function fetchConversations() {
            if (!selectedBot) return;
            try {
                const data = await apiCall('GET', `/bots/${encodeURIComponent(selectedBot)}/conversations`);
                renderConversations(data.conversations ?? []);
            } catch (e) {
                document.getElementById('conversationsContainer').innerHTML =
                    `<div style="color:#e55;font-size:0.85em;">Failed to load: ${escapeHtml(e.message)}</div>`;
            }
        }

        function renderConversations(conversations) {
            const container = document.getElementById('conversationsContainer');
            if (!conversations || conversations.length === 0) {
                container.innerHTML = '<div style="color:#555;font-size:0.85em;padding:6px 0;">No conversations recorded for this bot yet.</div>';
                return;
            }
            container.innerHTML = conversations.map((turn, i) => {
                const [system, human, ai] = turn;
                return `
                <details class="convo-turn" ${i === conversations.length - 1 ? 'open' : ''}>
                    <summary class="convo-summary">Turn ${i + 1} of ${conversations.length}</summary>
                    <div class="convo-body">
                        <details class="convo-part">
                            <summary class="convo-part-label convo-system">âš™ System Prompt</summary>
                            <pre class="convo-text">${escapeHtml(system)}</pre>
                        </details>
                        <details class="convo-part" open>
                            <summary class="convo-part-label convo-human">ğŸ‘¤ Human Message</summary>
                            <pre class="convo-text">${escapeHtml(human)}</pre>
                        </details>
                        <details class="convo-part" open>
                            <summary class="convo-part-label convo-ai">ğŸ¤– AI Response</summary>
                            <pre class="convo-text">${escapeHtml(ai)}</pre>
                        </details>
                    </div>
                </details>`;
            }).join('');
        }

        async function overrideInstruction() {
            if (!selectedBot) { showApiToast('Select a bot first', true); return; }
            const text = document.getElementById('instructionInput').value.trim();
            if (!text) { showApiToast('Enter an instruction to override with', true); return; }
            const bot = encodeURIComponent(selectedBot);
            try {
                await apiCall('POST', `/bots/${bot}/stop`, { clear_queue: false });
                await apiCall('DELETE', `/bots/${bot}/queue`);
                await apiCall('POST', `/bots/${bot}/explore`, { goal: text, preempt: true, reset_env: false });
                showApiToast(`ğŸ”¥ Override sent to ${selectedBot}: ${text}`);
                document.getElementById('instructionInput').value = '';
            } catch (e) {
                showApiToast(`Override failed: ${e.message}`, true);
            }
        }

        async function stopBotByName(name) {
            try {
                await apiCall('POST', `/bots/${encodeURIComponent(name)}/stop`, { clear_queue: false });
                showApiToast(`Stopped ${name}`);
            } catch (e) {
                showApiToast(`Stop failed: ${e.message}`, true);
            }
        }

        async function stopSelectedBot() {
            if (!selectedBot) { showApiToast('No bot selected', true); return; }
            await stopBotByName(selectedBot);
        }

        async function killBotByName(name) {
            if (!confirm(`Kill bot "${name}"? This cannot be undone.`)) return;
            try {
                await apiCall('DELETE', `/bots/${encodeURIComponent(name)}`);
                showApiToast(`Killed ${name}`);
                fetchBots();
            } catch (e) {
                showApiToast(`Kill failed: ${e.message}`, true);
            }
        }

        async function spawnBot() {
            const name = document.getElementById('spawnName').value.trim();
            const port = parseInt(document.getElementById('spawnPort').value.trim(), 10);
            if (!name || !port) { showApiToast('Bot Name and MC Port are required', true); return; }
            const body = { name, port };
            const username    = document.getElementById('spawnUsername').value.trim();
            const environment = document.getElementById('spawnEnvironment').value;
            const model       = document.getElementById('spawnModel').value;
            if (username)    body.username    = username;
            if (environment) body.environment = environment;
            if (model)       body.model       = model;
            try {
                await apiCall('POST', '/bots', body);
                showApiToast(`Spawned bot: ${name}`);
                fetchBots();
            } catch (e) {
                showApiToast(`Spawn failed: ${e.message}`, true);
            }
        }

        // â”€â”€ Command panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function updateCommandFields() {
            const type = document.getElementById('commandType').value;
            const mainInput = document.getElementById('instructionInput');
            document.getElementById('subgoalFields').classList.toggle('visible', type === 'subgoal');
            document.getElementById('skillFields').classList.toggle('visible', type === 'skill');
            document.getElementById('stopFields').classList.toggle('visible', type === 'stop');
            document.getElementById('taskOptions').style.display = type === 'task' ? 'flex' : 'none';
            mainInput.style.display = ['stop', 'pop_queue'].includes(type) ? 'none' : '';
            const placeholders = {
                task:      "Enter task (e.g., 'Mine 10 diamonds')",
                explore:   "Exploration goal â€” leave empty for open-ended (e.g., 'Find a village')",
                subgoal:   "Enter overall task description",
                skill:     "Parameters (comma-separated, optional)",
                pop_queue: "",
            };
            mainInput.placeholder = placeholders[type] || '';
        }

        async function sendInstruction() {
            if (!selectedBot) { showApiToast('Select a bot first', true); return; }
            const type = document.getElementById('commandType').value;
            const text = document.getElementById('instructionInput').value.trim();
            const bot  = encodeURIComponent(selectedBot);
            try {
                if (type === 'task') {
                    if (!text) { showApiToast('Enter a task', true); return; }
                    const preempt   = document.getElementById('preemptInput').checked;
                    const reset_env = document.getElementById('resetEnvInput').checked;
                    await apiCall('POST', `/bots/${bot}/task`, { task: text, reset_env, preempt });
                } else if (type === 'explore') {
                    // empty goal = open-ended exploration
                    const body = text ? { goal: text } : {};
                    await apiCall('POST', `/bots/${bot}/explore`, body);
                } else if (type === 'subgoal') {
                    if (!text) { showApiToast('Enter a task description', true); return; }
                    const raw = document.getElementById('subGoalsInput').value.trim();
                    const sub_goals = raw ? raw.split('\n').map(s => s.trim()).filter(Boolean) : [];
                    await apiCall('POST', `/bots/${bot}/subgoal`, { task: text, sub_goals });
                } else if (type === 'skill') {
                    const skill_path = document.getElementById('skillPathInput').value.trim();
                    if (!skill_path) { showApiToast('Enter a skill path', true); return; }
                    const parameters = text ? text.split(',').map(s => s.trim()).filter(Boolean) : [];
                    await apiCall('POST', `/bots/${bot}/skill`, { skill_path, parameters });
                } else if (type === 'stop') {
                    const clear_queue = document.getElementById('clearQueueInput').checked;
                    await apiCall('POST', `/bots/${bot}/stop`, { clear_queue });
                } else if (type === 'pop_queue') {
                    await apiCall('DELETE', `/bots/${bot}/queue/pop`);
                }
                showApiToast(`âœ“ ${type} sent to ${selectedBot}`);
                document.getElementById('instructionInput').value = '';
            } catch (e) {
                showApiToast(`Error: ${e.message}`, true);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('instructionInput').addEventListener('keypress', e => {
                if (e.key === 'Enter' && e.ctrlKey) sendInstruction();
            });

            checkApiStatus();
            fetchBots();
            setInterval(checkApiStatus, 5000);
            setInterval(fetchBots, 5000);
        });

        // â”€â”€ Server activity log (derived from live /bots poll) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        const _activityLog = [];   // {time, msg} â€” rolling 30-entry buffer
        let   _lastBotSnapshot = {};

        function updateActivityFromBots(bots) {
            const now = new Date().toLocaleTimeString();
            bots.forEach(bot => {
                const prev = _lastBotSnapshot[bot.name];
                if (!prev) {
                    _activityLog.unshift({ time: now, msg: `${bot.name} registered (port ${bot.port})` });
                } else if (prev.status !== bot.status) {
                    _activityLog.unshift({ time: now, msg: `${bot.name}: ${prev.status} â†’ ${bot.status}${bot.currentTask ? ' â€” ' + bot.currentTask : ''}` });
                } else if (prev.currentTask !== bot.currentTask && bot.currentTask) {
                    _activityLog.unshift({ time: now, msg: `${bot.name}: task â†’ ${bot.currentTask}` });
                }
                _lastBotSnapshot[bot.name] = { status: bot.status, currentTask: bot.currentTask };
            });
            // detect removed bots
            Object.keys(_lastBotSnapshot).forEach(name => {
                if (!bots.find(b => b.name === name)) {
                    _activityLog.unshift({ time: now, msg: `${name} removed` });
                    delete _lastBotSnapshot[name];
                }
            });
            if (_activityLog.length > 30) _activityLog.length = 30;
            renderActivityLog();
        }

        function renderActivityLog() {
            const container = document.getElementById('serverLogContainer');
            if (_activityLog.length === 0) {
                container.innerHTML = `<div class="log-entry"><div class="log-time">--:--:--</div><div class="log-action">No events yet.</div></div>`;
                return;
            }
            container.innerHTML = _activityLog.map(e =>
                `<div class="log-entry"><div class="log-time">${e.time}</div><div class="log-action">${escapeHtml(e.msg)}</div></div>`
            ).join('');
        }
    </script>
</body>
</html>
