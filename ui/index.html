<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Agents Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>‚õèÔ∏è Minecraft Agents Dashboard</h1>
            <p class="subtitle">Real-time AI Bot Monitoring</p>
            <div class="api-status">
                <div class="api-dot" id="apiDot"></div>
                <span id="apiStatusLabel">API Offline</span>
            </div>
        </header>

        <div class="stats-bar">
            <div class="stat-box">
                <div class="stat-number" id="statTotalBots">‚Äî</div>
                <div class="stat-label">Total Bots</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="statActiveBots">‚Äî</div>
                <div class="stat-label">Active Bots</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="statOnline">‚Äî</div>
                <div class="stat-label">Online Now</div>
            </div>
        </div>

        <!-- AI Bots Section -->
        <div class="section">
            <h2 class="section-title">ü§ñ AI Bots</h2>
            <div id="apiBotCards" class="cards"></div>
        </div>

        <!-- Instruction Window -->
        <div class="instruction-window">
            <div class="instruction-header">
                <div>
                    <div class="instruction-title">üìù Send Instruction</div>
                    <div class="instruction-target" id="targetName">Select a bot to instruct</div>
                </div>
                <select class="command-type-select" id="commandType" onchange="updateCommandFields()">
                    <option value="task">Task</option>
                    <option value="explore">Explore</option>
                    <option value="subgoal">Subgoal</option>
                    <option value="skill">Skill</option>
                    <option value="stop">Stop</option>
                </select>
            </div>

            <textarea id="instructionInput" class="instruction-input"
                placeholder="Enter instruction (e.g., 'Mine 10 diamonds')"></textarea>

            <div class="extra-fields" id="subgoalFields">
                <label>Sub-goals (one per line):</label>
                <textarea id="subGoalsInput" class="instruction-input" style="min-height:60px;"
                    placeholder="chop oak tree&#10;collect 10 logs"></textarea>
            </div>

            <div class="extra-fields" id="skillFields">
                <label>Skill path:</label>
                <input type="text" id="skillPathInput" placeholder="./skill_library/craftWoodenPlanks.js">
            </div>

            <div class="extra-fields" id="stopFields">
                <label><input type="checkbox" id="clearQueueInput"> Clear task queue</label>
            </div>

            <div class="button-row">
                <button class="instruction-button" onclick="sendInstruction()">‚ö° Send</button>
                <button class="instruction-button-stop" onclick="stopSelectedBot()">‚èπ Stop Bot</button>
            </div>
        </div>

        <!-- Server Activity Log -->
        <div class="section">
            <div class="section-title">üì° Server Activity</div>
            <div style="color:#a0a0a0; margin-bottom:8px; font-size:0.85em;">Real-time bot activity (connected, started tasks, completed, errors)</div>
            <div id="serverLogContainer"></div>
        </div>

        <!-- Spawn Bot -->
        <div class="section">
            <div class="section-title">‚ö° Spawn Bot</div>
            <div class="spawn-form">
                <div class="spawn-form-group">
                    <label>Bot Name *</label>
                    <input type="text" id="spawnName" placeholder="bot1">
                </div>
                <div class="spawn-form-group">
                    <label>Environment</label>
                    <select id="spawnEnvironment">
                        <option value="">Default</option>
                        <option value="explore">Explore</option>
                        <option value="combat">Combat</option>
                        <option value="farming">Farming</option>
                        <option value="subgoal">Subgoal</option>
                    </select>
                </div>
            </div>
            <button class="instruction-button" onclick="spawnBot()">‚ö° Spawn Bot</button>
        </div>
    </div>

    <div id="apiToast"></div>

    <script>
        const API_BASE = 'http://localhost:8001';
        let selectedBot = null;

        // ‚îÄ‚îÄ API helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function apiCall(method, path, body) {
            const opts = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) opts.body = JSON.stringify(body);
            const res = await fetch(API_BASE + path, opts);
            if (!res.ok) {
                const text = await res.text().catch(() => res.statusText);
                throw new Error(`${res.status}: ${text}`);
            }
            return res.json().catch(() => ({}));
        }

        let _toastTimer = null;
        function showApiToast(msg, isError = false) {
            const el = document.getElementById('apiToast');
            el.textContent = msg;
            el.className = isError ? 'error' : 'success';
            el.style.display = 'block';
            clearTimeout(_toastTimer);
            _toastTimer = setTimeout(() => { el.style.display = 'none'; }, 3500);
            
            // Also add to activity log
            addActivityEntry('UI', isError ? '‚ö†Ô∏è' : '‚úì', msg);
        }

        function addActivityEntry(botName, action, details) {
            const container = document.getElementById('serverLogContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const timestamp = new Date().toLocaleTimeString();
            const actionText = `<strong>${escapeHtml(botName)}</strong> ${escapeHtml(action)} ${escapeHtml(details || '')}`;
            entry.innerHTML = `<div class="log-time">${timestamp}</div><div class="log-action">${actionText}</div>`;
            
            // Add to top of container
            if (container.firstChild) {
                container.insertBefore(entry, container.firstChild);
            } else {
                container.appendChild(entry);
            }
            
            // Keep only last 100 entries
            while (container.children.length > 100) {
                container.removeChild(container.lastChild);
            }
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // ‚îÄ‚îÄ API status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function checkApiStatus() {
            const dot = document.getElementById('apiDot');
            const label = document.getElementById('apiStatusLabel');
            try {
                await fetch(API_BASE + '/bots', { signal: AbortSignal.timeout(3000) });
                dot.classList.add('online');
                label.textContent = 'API Connected';
            } catch {
                dot.classList.remove('online');
                label.textContent = 'API Offline';
            }
        }

        // ‚îÄ‚îÄ Bot listing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function fetchBots() {
            try {
                const data = await apiCall('GET', '/bots');
                // API returns either an array or an object keyed by bot name
                const bots = Array.isArray(data) ? data : Object.values(data);
                renderApiBots(bots);
                const active = bots.filter(b => b.status === 'running').length;
                const online = bots.filter(b => b.status !== 'dead').length;
                document.getElementById('statTotalBots').textContent = bots.length;
                document.getElementById('statActiveBots').textContent = active;
                document.getElementById('statOnline').textContent = online;
            } catch {
                renderApiBots([]);
            }
        }

        function renderApiBots(bots) {
            const container = document.getElementById('apiBotCards');
            container.innerHTML = '';
            if (bots.length === 0) {
                container.innerHTML = '<div style="color:#666;font-size:0.85em;padding:8px 0;">No live bots ‚Äî start a bot or check the API connection.</div>';
                return;
            }
            bots.forEach(bot => {
                const statusClass = { idle: 'idle', running: 'online', error: 'offline', dead: 'offline', starting: 'idle' }[bot.status] || 'idle';
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-header">
                        <span class="player-name">${escapeHtml(bot.name)}<span class="bot-badge">AI</span></span>
                        <span class="status ${statusClass}">${escapeHtml(bot.status)}</span>
                    </div>
                    <div class="card-stats">
                        <div class="stat-item"><span>Task:</span><span class="stat-value">${escapeHtml(bot.currentTask || 'idle')}</span></div>
                    </div>
                    <div class="live-bot-actions">
                        <button class="btn-sm btn-select" onclick="selectBotByName('${escapeHtml(bot.name)}')">Select</button>
                        <button class="btn-sm btn-stop"   onclick="stopBotByName('${escapeHtml(bot.name)}')">Stop</button>
                        <button class="btn-sm btn-kill"   onclick="killBotByName('${escapeHtml(bot.name)}')">Kill</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // ‚îÄ‚îÄ Bot actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function selectBotByName(name) {
            selectedBot = name;
            document.getElementById('targetName').textContent = `Instructing: ${name}`;
            showApiToast(`Selected bot: ${name}`);
        }

        async function stopBotByName(name) {
            try {
                await apiCall('POST', `/bots/${encodeURIComponent(name)}/stop`, { clear_queue: false });
                showApiToast(`Stopped ${name}`);
            } catch (e) {
                showApiToast(`Stop failed: ${e.message}`, true);
            }
        }

        async function stopSelectedBot() {
            if (!selectedBot) { showApiToast('No bot selected', true); return; }
            await stopBotByName(selectedBot);
        }

        async function killBotByName(name) {
            if (!confirm(`Kill bot "${name}"? This cannot be undone.`)) return;
            try {
                await apiCall('DELETE', `/bots/${encodeURIComponent(name)}`);
                showApiToast(`Killed ${name}`);
                fetchBots();
            } catch (e) {
                showApiToast(`Kill failed: ${e.message}`, true);
            }
        }

        async function spawnBot() {
            const name = document.getElementById('spawnName').value.trim();
            if (!name) { showApiToast('Bot Name is required', true); return; }

            // Auto-assign port: start at 3000, increment past any in-use ports
            let port = 3000;
            try {
                const data = await apiCall('GET', '/bots');
                const bots = Array.isArray(data) ? data : Object.values(data);
                const usedPorts = bots.map(b => b.port).filter(p => p >= 3000);
                while (usedPorts.includes(port)) port++;
            } catch {}

            const body = { name, port, username: name };
            const environment = document.getElementById('spawnEnvironment').value;
            if (environment) body.environment = environment;
            try {
                await apiCall('POST', '/bots', body);
                showApiToast(`Spawned bot: ${name}`);
                document.getElementById('spawnName').value = '';
                document.getElementById('spawnEnvironment').value = '';
                fetchBots();
            } catch (e) {
                showApiToast(`Spawn failed: ${e.message}`, true);
            }
        }

        // ‚îÄ‚îÄ Command panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function updateCommandFields() {
            const type = document.getElementById('commandType').value;
            const mainInput = document.getElementById('instructionInput');
            document.getElementById('subgoalFields').classList.toggle('visible', type === 'subgoal');
            document.getElementById('skillFields').classList.toggle('visible', type === 'skill');
            document.getElementById('stopFields').classList.toggle('visible', type === 'stop');
            mainInput.style.display = type === 'stop' ? 'none' : '';
            const placeholders = {
                task:    "Enter task (e.g., 'Mine 10 diamonds')",
                explore: "Enter exploration goal (e.g., 'Find a village')",
                subgoal: "Enter overall task description",
                skill:   "Parameters (comma-separated, optional)",
            };
            mainInput.placeholder = placeholders[type] || '';
        }

        async function sendInstruction() {
            if (!selectedBot) { showApiToast('Select a bot first', true); return; }
            const type = document.getElementById('commandType').value;
            const text = document.getElementById('instructionInput').value.trim();
            try {
                if (type === 'task') {
                    if (!text) { showApiToast('Enter a task', true); return; }
                    await apiCall('POST', `/bots/${encodeURIComponent(selectedBot)}/task`, { task: text });
                } else if (type === 'explore') {
                    if (!text) { showApiToast('Enter a goal', true); return; }
                    await apiCall('POST', `/bots/${encodeURIComponent(selectedBot)}/explore`, { goal: text });
                } else if (type === 'subgoal') {
                    if (!text) { showApiToast('Enter a task description', true); return; }
                    const raw = document.getElementById('subGoalsInput').value.trim();
                    const sub_goals = raw ? raw.split('\n').map(s => s.trim()).filter(Boolean) : [];
                    await apiCall('POST', `/bots/${encodeURIComponent(selectedBot)}/subgoal`, { task: text, sub_goals });
                } else if (type === 'skill') {
                    const skill_path = document.getElementById('skillPathInput').value.trim();
                    if (!skill_path) { showApiToast('Enter a skill path', true); return; }
                    const parameters = text ? text.split(',').map(s => s.trim()).filter(Boolean) : [];
                    await apiCall('POST', `/bots/${encodeURIComponent(selectedBot)}/skill`, { skill_path, parameters });
                } else if (type === 'stop') {
                    const clear_queue = document.getElementById('clearQueueInput').checked;
                    await apiCall('POST', `/bots/${encodeURIComponent(selectedBot)}/stop`, { clear_queue });
                }
                showApiToast(`‚úì ${type} sent to ${selectedBot}`);
                document.getElementById('instructionInput').value = '';
            } catch (e) {
                showApiToast(`Error: ${e.message}`, true);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('instructionInput').addEventListener('keypress', e => {
                if (e.key === 'Enter' && e.ctrlKey) sendInstruction();
            });

            checkApiStatus();
            fetchBots();
            setInterval(checkApiStatus, 5000);
            setInterval(fetchBots, 5000);
        });

        // ‚îÄ‚îÄ Server activity log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        let _lastServerActivityTime = 0;

        async function fetchBotActivity() {
            const container = document.getElementById('serverLogContainer');
            try {
                const res = await fetch(`${API_BASE}/activity?limit=50`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const events = data.activity || [];
                
                // Only add new events that arrived after last fetch
                events.forEach(ev => {
                    const eventTime = new Date(ev.fullTime).getTime();
                    if (eventTime > _lastServerActivityTime) {
                        addActivityEntry(ev.botName, ev.action, ev.details);
                        _lastServerActivityTime = eventTime;
                    }
                });
            } catch (err) {
                console.error('Failed to fetch activity:', err);
            }
        }

        setInterval(() => fetchBotActivity().catch(() => {}), 5000);
        fetchBotActivity().catch(() => {});
    </script>
</body>
</html>
